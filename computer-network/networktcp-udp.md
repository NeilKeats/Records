> TCP、UDP是传输层的服务，为应用进程提供通信。

# 重要概念

1. **传输层**为互相通信的应用**进程**提供**逻辑通信（端到端）**

2. **端口\(port\)**与**套接字\(socket\)**

3. **无连接的UDP，不可靠信道**

4. **面向连接的TCP，全双工的可靠信道**

5. 在不可靠网络上实现**可靠传输**的原理，**停止等待协议**、**ARQ协议**

6. TCP的**滑动窗口**、**流量控制**、**拥塞控制**和**连接管理**

# 运输层的端口

运输层从IP层收到数据后，需要交付给特定应用进程，因此需要**标志**运行在应用层的各种应用进程。为了不同OS的应用进程可以互相通信，需要用统一的方法（与OS无关）标志。

**协议端口号（端口，port）**

TCP/IP使用16位的端口（65535个），TCP和UDP的首部都有**源端口**和**目的端口**，端口是标志**本计算机**应用层的各个进程与传输层交互的层间接口，只具有**本地意义**。通信时需要知道对方IP地址、端口

**端口分类**

1. **服务器使用端口**
   1. 熟知端口号、（系统端口号）：0-1023
   2. 登记端口号：没有熟知端口的应用程序使用，1024-49151
2. **客户端使用的端口号（短暂端口号）**
   1. 49512-65535，客户端进程运行时动态选择，暂时使用

# UDP

* 无连接的
* 尽最大努力交付
* **面向报文**，发送方的UDP对应用程序交下的报文，添加首部后就交付给IP层，不合并也不分拆。一次交付一个完整的报文。
* 没有拥塞控制，**拥塞不会降低发送速率**。对于实时的应用，要求主机以恒定速率发送数据，可以容忍丢失但是对延迟敏感，使用UDP。
* 支持**一对一、一对多、多对一、多对多的交互通信**
* 首部开销小（8个字节）

## UDP的首部格式

每个字段**2字节**

* 源端口，不需要对方回信时可全0
* 目的端口
* 长度，最小值为8（仅有首部）
* 校验和

接收方从IP层收到UDP数据报时，根据目的端口分发给应用进程。

若接收方UDP发现收到的报文中的目的端口不正确（不存在对应这个端口的应用进程），则丢弃报文，使用ICMP发送“端口不可达给发送方”

**校验和**

计算时要加入**伪首部**，伪首部仅用于计算校验和而不向上或向下传递，计算校验和的部分包括：伪首部、首部、数据部分。同时检查了包括IP数据报源地址、目的地址（伪首部），UDP源端口、目的端口（UDP首部），以及UDP数据部分。

# TCP

* 面向连接的传输层协议：应用使用之前必须先建立连接，传输完毕后必须释放已建立的TCP连接。
* 每条TCP连接只能有两个端点，是点对点的
* 提供可靠交付服务
* 全双工通信，设有发送、接收缓存
* 面向字节流，TCP的“流”指的是流入到进程或者从进程流出的字节序列

> TCP并不关心应用进程一次将多长的报文发送到TCP缓存中，而根据对方给出的**窗口值**、**网络拥塞程度**决定一个报文段要包含多少个字节。

**TCP的连接**

TCP连接的端点是socket

```
套接字socket=(IP地址:端口号)
TCP连接 ::= {socket1,socket2} = {(IP1:port1), (IP2:port2)}
```

> 同一个IP地址可以有多个不同的TCP链接，同一个端口号也可以出现在多个不同的TCP连接中

## 可靠传输

TCP下层不提供可靠传输，需要协议实现：

* 出现差错时，让发送方**重传**出现差错的数据。（实际信道会产生差错）
* 接收方来不及处理数据时，告知发送方**降低发送速率**。（实际接收方处理速度有限）



