> TCP、UDP是传输层的服务，为应用进程提供通信。

# 重要概念

1. **传输层**为互相通信的应用**进程**提供**逻辑通信（端到端）**

2. **端口\(port\)**与**套接字\(socket\)**

3. **无连接的UDP，不可靠信道**

4. **面向连接的TCP，全双工的可靠信道**

5. 在不可靠网络上实现**可靠传输**的原理，**停止等待协议**、**ARQ协议**

6. TCP的**滑动窗口**、**流量控制**、**拥塞控制**和**连接管理**

# 运输层的端口

运输层从IP层收到数据后，需要交付给特定应用进程，因此需要**标志**运行在应用层的各种应用进程。为了不同OS的应用进程可以互相通信，需要用统一的方法（与OS无关）标志。

**协议端口号（端口，port）**

TCP/IP使用16位的端口（65535个），TCP和UDP的首部都有**源端口**和**目的端口**，端口是标志**本计算机**应用层的各个进程与传输层交互的层间接口，只具有**本地意义**。通信时需要知道对方IP地址、端口

**端口分类**

1. **服务器使用端口**
   1. 熟知端口号、（系统端口号）：0-1023
   2. 登记端口号：没有熟知端口的应用程序使用，1024-49151
2. **客户端使用的端口号（短暂端口号）**
   1. 49512-65535，客户端进程运行时动态选择，暂时使用

![](/assets/TCP_UDP_Application.png)

# UDP

* 无连接的
* 尽最大努力交付
* **面向报文**，发送方的UDP对应用程序交下的报文，添加首部后就交付给IP层，不合并也不分拆。一次交付一个完整的报文。
* 没有拥塞控制，**拥塞不会降低发送速率**。对于实时的应用，要求主机以恒定速率发送数据，可以容忍丢失但是对延迟敏感，使用UDP。
* 支持**一对一、一对多、多对一、多对多的交互通信**
* 首部开销小（8个字节）

## UDP的首部格式

每个字段**2字节**

* 源端口，不需要对方回信时可全0
* 目的端口
* 长度，最小值为8（仅有首部）
* 校验和

接收方从IP层收到UDP数据报时，根据目的端口分发给应用进程。

若接收方UDP发现收到的报文中的目的端口不正确（不存在对应这个端口的应用进程），则丢弃报文，使用ICMP发送“端口不可达给发送方”

**校验和**

计算时要加入**伪首部**，伪首部仅用于计算校验和而不向上或向下传递，计算校验和的部分包括：伪首部、首部、数据部分。同时检查了包括IP数据报源地址、目的地址（伪首部），UDP源端口、目的端口（UDP首部），以及UDP数据部分。

![](/assets/UDP_header.png)

# TCP

* 面向连接的传输层协议：应用使用之前必须先建立连接，传输完毕后必须释放已建立的TCP连接。
* 每条TCP连接只能有两个端点，是点对点的
* 提供可靠交付服务
* 全双工通信，设有发送、接收缓存
* **面向字节流**，TCP的“流”指的是流入到进程或者从进程流出的字节序列。**但TCP传输单元是报文段**。

> TCP并不关心应用进程一次将多长的报文发送到TCP缓存中，而根据对方给出的**窗口值**、**网络拥塞程度**决定一个报文段要包含多少个字节。

![](/assets/TCP_stream.png)

**TCP的连接**

TCP连接的端点是socket

```
套接字socket=(IP地址:端口号)
TCP连接 ::= {socket1,socket2} = {(IP1:port1), (IP2:port2)}
```

> 同一个IP地址可以有多个不同的TCP链接，同一个端口号也可以出现在多个不同的TCP连接中

## 可靠传输原理

TCP下层不提供可靠传输，需要协议实现：

* 出现差错时，让发送方**重传**出现差错的数据。（实际信道会产生差错）
* 接收方来不及处理数据时，告知发送方**降低发送速率**。（实际接收方处理速度有限）

### 停止等待协议

发送完一个就停止并等待对方的确认，收到确认在发送下一个分组。

**超时重传**：超过一段时间没有收到确认，就认为丢失了，则重新发送分组。（需要设置超时器）

-   发送完毕后，需要保留**分组副本**
-   **分组**和**确认分组**，都需要进行编号
-   超时器设置的重传时间，应该比平均RTT更长一些。

**确认丢失**：接收到分组后，又收到了重传的同一个分组。

-   **丢弃**这个重复的分组
-   向对方**发送确认**（不能认为已发送过确认，就不再发送）

**确认迟到**：收到重复的确认，并丢弃

使用以上确认、重传机制，可以实现可靠的通信。（ARQ：Automatic Repeat reQuest）

**信道利用率**：利用率很低，解决方法：**流水线传输**，**连续ARQ协议**和**滑动窗口协议**



### 连续ARQ协议

**发送方**：维持**发送窗口**，每收到一个确认则把发送窗口前移一个分组的位置。

**接收方**：**累计确认**，不对每一个收到的分组都发送确认，**对按序到的的最后一个分组发送确认**。

>   基础版本：Go-back-N，发送方发5个分组，第三个丢失了，但他不知道后两个是否到达，必须重退到第3个开始发送



## TCP报文的首部

前20字节固定，后面有4n字节是根据需要而增加的选项。头部最长60字节（受限于数据偏移字段长度，20 + (2^4 - 1)* 4Byte）

1.  **源端口**、**目的端口**

2.  **序号**，4字节，传输的字节流中，**每一个字节按顺序编号**（mod 2^32），首部中的值是**本报文段发送的数据的第一个字节的序号**（头部序号字段是301，携带100个字节，则最后一个字节序号是400）。初始序号，在连接建立时设置。

3.  **确认号**，4字节，是**期望收到对方下一个报文段的第一个数据字节的序号**。（若收到301-400的报文段，则确认报文的确认号为401）

    1.  >   **确认号为N，则N-1为止的所有数据都已正确收到。**

4.  **数据偏移**，即报文段起始距离数据的距离，也就是首部长度。

5.  **保留**

6.  **紧急URG**，置1表示有效

7.  **确认ACK**（ACKnowlegment），连接建立后所有报文都置为1

8.  **推送PSH**

9.  **复位RST**， RST == 1时，表明TCP连接出现严重错误，必须释放连接再重新建立连接。也用于拒绝非法报文段，或拒打开连接。

10.  **同步SYN**，用于连接建立时同步序号，当SYN==1且ACK==0是连接请求报文段，若对方同意建立连接则响应报文使SYN==1和ACK==1。（SYN置为1则表明，是一个连接请求或连接接受报文）

11.  ​